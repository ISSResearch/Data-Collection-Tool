stages:
  - test

build and tests application:
  stage: test
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    GIT_SSL_NO_VERIFY: "1"
  before_script:
    - echo "Setting environment up..."
    - echo "DEBUG=True" >> back/proj_back/.env
    - echo "SERVER_ORIGINS='127.0.0.1,localhost,iss-test-front,iss-front,iss-test-back,iss-back'" >> back/proj_back/.env
  script:
    - echo $CI
    - echo "Starting docker test app..."
    - docker-compose -f docker-compose.test.yml build
    - docker-compose -f docker-compose.test.yml up -d --force-recreate
    - sleep 30
    - echo "Running tests..."
    - echo "Backend tests:"
    - docker exec iss-test-back ./manage.py test
    - echo "Frontend tests:"
    - docker exec iss-test-front npm test
    - echo "Seleium tests:"
    - docker exec iss-test-ui python3 test.py
    - docker exec iss-test-ui python3 flake8
  after_script:
    - docker-compose -f docker-compose.test.yml down --volumes